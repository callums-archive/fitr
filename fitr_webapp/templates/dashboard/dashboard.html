{% extends  'base/layout.html'%}

{% block styles %}

{% endblock styles %}

{% block content %}
<div class="container cont-margin">
  <div class="row row-flex">
    <div class="col s12 m6">
      <div class="card-panel {{ colours['primary_card'] }} p-2">
        <h6 class="center">Weight Graph (Latest 5)</h6>
        <div class="divider"></div>
        <div id="weight_chart"></div>
      </div>
    </div>

    <div class="col s12 m6">
      <div class="card-panel {{ colours['primary_card'] }} p-2">
        <h6 class="center">Weight Table (Latest 5)</h6>
        <div class="divider"></div>
        <div class="encase_weights_datatable">
          <table id="weights_datatable" class="display" style="width:100%; height: 100%"></table>
        </div>
      </div>
    </div>

  </div>

  <div class="row row-flex">
    <div class="col s12">
      <div class="card-panel {{ colours['primary_card'] }} p-2">
        <h6 class="center">Measurements Graph (Latest 5)</h6>
        <div class="divider"></div>
        <div id="measurements_chart"></div>
      </div>
    </div>
  </div>
  <div class="row row-flex">

    <div class="col s12">
      <div class="card-panel {{ colours['primary_card'] }} p-2">
        <h6 class="center">Measurements Table (Latest 5)</h6>
        <div class="divider"></div>
        <div class="encase_measurements_datatable">
          <table id="measurements_datatable" class="display" style="width:100%; height: 100%"></table>
        </div>
      </div>
    </div>

  </div>
</div>

{% endblock content %}

{% block scripts %}
<script>
  $(document).ready(function() {

    // chart vars
    var weights_chart = undefined;


    // weight table
    var weights_datatable = $('#weights_datatable').DataTable({
      paging: false,
      info: false,
      responsive: true,
      lengthChange: false,
      filter: false,
      columns: [{
          title: "Date",
          data: "create_stamp"
        },
        {
          title: "Weight",
          data: "weight",
          render: function(data, type, row, meta) {
            if (data > 0) {
              return `${data}${row.unit}`
            }
            return "-"
          }
        },
        {
          title: "Prev. Diff",
          data: "weight",
          render: function(data, type, row, meta) {
            prev = meta.row-1;
            if (prev != -1) {
              diff_prev = data - weights_datatable.rows().data()[prev].weight;
              return `${diff_prev.toFixed(1)}${row.unit}`;
            }
            return "-"
          }
        },
        {
          title: "Diff Init.",
          data: "weight",
          render: function(data, type, row, meta) {
            init = weights_datatable.ajax.json().initial_weight;
            diff_init = data - init
            return `${diff_init.toFixed(1)}${row.unit}`;
          }
        },
        {
          title: "Capturer",
          data: "create_user"
        },
      ],
      ajax: "{{ url_for('User:get_weights', user=request.user.username) }}",
      order: [
        [0, "desc"]
      ],
      "fnInitComplete": function(oSettings, json) {
        chart_data = [];
        data_len = weights_datatable.rows().data().length;
        for (var i=0; i != data_len; i++) {
          arr_item = weights_datatable.rows().data()[i]
          chart_data.push({"date": arr_item["create_stamp"].split(" ")[0], "weight": `${arr_item["weight"]}${arr_item["unit"]}`});
        }
        weights_chart = new Morris.Line({
          element: 'weight_chart',
          data: chart_data.reverse(),
          xLabelMargin: 1,
          xkey: 'date',
          ymax: weights_datatable.ajax.json().initial_weight + 50,
          ykeys: ['weight'],
          labels: ['Value'],
          resize: true,
          redraw: true,
          hideHover: 'auto',
        });

        dynamicChart(weights_chart, ".encase_weights_datatable");
      }
    });
    $("select[name='weights_datatable_length']").formSelect();

    var measurements_datatable = $('#measurements_datatable').DataTable({
      paging: false,
      info: false,
      responsive: true,
      lengthChange: false,
      filter: false,
      columns: [{
          title: "Date",
          data: "create_stamp"
        },
        {
          title: "Neck",
          data: "neck",
          render: function(data, type, row, meta) {
            if (data > 0) {
              return `${data}${row.unit}`
            }
            return "-"
          }
        },
        {
          title: "Bicep",
          data: "bicep",
          render: function(data, type, row, meta) {
            if (data > 0) {
              return `${data}${row.unit}`
            }
            return "-"
          }
        },
        {
          title: "Chest",
          data: "chest",
          render: function(data, type, row, meta) {
            if (data > 0) {
              return `${data}${row.unit}`
            }
            return "-"
          }
        },
        {
          title: "ABS 1",
          data: "abs1",
          render: function(data, type, row, meta) {
            if (data > 0) {
              return `${data}${row.unit}`
            }
            return "-"
          }
        },
        {
          title: "ABS 2",
          data: "abs2",
          render: function(data, type, row, meta) {
            if (data > 0) {
              return `${data}${row.unit}`
            }
            return "-"
          }
        },
        {
          title: "ABS 3",
          data: "abs3",
          render: function(data, type, row, meta) {
            if (data > 0) {
              return `${data}${row.unit}`
            }
            return "-"
          }
        },
        {
          title: "Upper Thigh",
          data: "upperthigh",
          render: function(data, type, row, meta) {
            if (data > 0) {
              return `${data}${row.unit}`
            }
            return "-"
          }
        },
        {
          title: "Mid Thigh",
          data: "midthigh",
          render: function(data, type, row, meta) {
            if (data > 0) {
              return `${data}${row.unit}`
            }
            return "-"
          }
        },
        {
          title: "Calf",
          data: "calf",
          render: function(data, type, row, meta) {
            if (data > 0) {
              return `${data}${row.unit}`
            }
            return "-"
          }
        },
        {
          title: "Total",
          render: function(data, type, row, meta) {
            var total = 0;
            for (measure in row) {
              if (!measure.includes("_") & measure != "unit") {
                total+=row[measure];
              }
            }
            return `${total}${row.unit}`
          }
        },
        {
          title: "Diff.",
          render: function(data, type, row, meta) {
            prev = meta.row-1;
            if (prev != -1) {
                var total_curr = 0;
                for (measure in row) {
                  if (!measure.includes("_") & measure != "unit") {
                    total_curr+=row[measure];
                  }
                }
                var total_prev = 0;
                for (measure in measurements_datatable.rows().data()[prev]) {
                  if (!measure.includes("_") & measure != "unit") {
                    total_prev+=measurements_datatable.rows().data()[prev][measure];
                  }
                }
                return `${total_curr-total_prev}${row.unit}`;
            }
            return "-"

          }
        },
        {
          title: "Capturer",
          data: "create_user"
        },
      ],
      ajax: "{{ url_for('User:get_measurements', user=request.user.username) }}",
      order: [
        [0, "desc"]
      ],
      "fnInitComplete": function(oSettings, json) {
        var data_len = json.data.length;
        var chart_datasets = [];

        for (var i=0; i<data_len; i++) {
          data = json.data[i];
          chart_datasets.push([
          {meta: data["create_stamp"].split(" ")[0], value: data["neck"]},
          {meta: data["create_stamp"].split(" ")[0], value: data["bicep"]},
          {meta: data["create_stamp"].split(" ")[0], value: data["chest"]},
          {meta: data["create_stamp"].split(" ")[0], value: data["abs1"]},
          {meta: data["create_stamp"].split(" ")[0], value: data["abs2"]},
          {meta: data["create_stamp"].split(" ")[0], value: data["abs3"]},
          {meta: data["create_stamp"].split(" ")[0], value: data["upperthigh"]},
          {meta: data["create_stamp"].split(" ")[0], value: data["midthigh"]},
          {meta: data["create_stamp"].split(" ")[0], value: data["calf"]},
        ]);
      }

        console.log(chart_datasets);

        var chart = new Chartist.Line('#measurements_chart', {
          labels: ['Neck', 'Bicep', 'Chest', 'ABS1', 'ABS2', 'ABS3', 'Upper Thigh', 'Mid Thigh', 'Calf'],
          series: chart_datasets
        }, {
          fullWidth: true,
          chartPadding: {
            right: 25,
            left: -10
          },
          plugins: [
            Chartist.plugins.tooltip()
          ]
        });


        // chart_data = [];
        // seperated_chart_data = [];
        //
        // for (var i=0; i != data_len; i++) {
        //   arr_item = json.data[i]
        //   chart_data.push({
        //     "date": arr_item["create_stamp"].split(" ")[0],
        //     "neck": `${arr_item["neck"]}${arr_item["unit"]}`,
        //     "bicep": `${arr_item["bicep"]}${arr_item["unit"]}`,
        //     "chest": `${arr_item["chest"]}${arr_item["unit"]}`,
        //     "abs1": `${arr_item["abs1"]}${arr_item["unit"]}`,
        //     "abs2": `${arr_item["abs2"]}${arr_item["unit"]}`,
        //     "abs3": `${arr_item["abs3"]}${arr_item["unit"]}`,
        //     "upperthigh": `${arr_item["upperthigh"]}${arr_item["unit"]}`,
        //     "midthigh": `${arr_item["midthigh"]}${arr_item["unit"]}`,
        //     "calf": `${arr_item["calf"]}${arr_item["unit"]}`,
        //   });
        // }

        // chart_data.forEach(function(obj) {
        //   Object.keys(obj).forEach(function(measure) {
        //     var added = false;
        //     seperated_chart_data.forEach(function(sep_data) {
        //       if (sep_data.measurement == measure) {
        //         sep_data[obj.date] = obj[measure];
        //         added = true;
        //       }
        //     })
        //     if (added != true & measure != "date") {
        //       new_measurement = {measurement: measure};
        //       new_measurement[obj.date] = obj[measure];
        //       seperated_chart_data.push(new_measurement);
        //     }
        //   })
        // });
        //
        // measure_labels = Object.keys(seperated_chart_data[0])
        // measure_labels.splice(0, 1);
        //
        // measure_labels_x = Object.keys(chart_data[0])
        // measure_labels_x.splice(0, 1);
        // console.log(measure_labels);
        //
        // console.log(measure_labels);
        // console.log(seperated_chart_data);
        // console.log(chart_data[0]);
        //
        // test = []
        // for (x in chart_data[0]) {
        //   if (x != "date") {
        //     test.push(parseInt(chart_data[0][x]))
        //   }
        // }
        // console.log(test);
        // console.log(measure_labels_x);


//         labels: [1, 2, 3],
// series:
// }, {
// fullWidth: true,
// plugins: [
//   Chartist.plugins.tooltip({
//     appendToBody: true
//   })
// ]
// });

        // var ctx = document.getElementById('measurement_chart').getContext('2d');
        // var myChart = new Chart(ctx, {
        //     type: 'line',
        //     data: {
        //         labels: ["neck", "bicep", "chest", "abs1", "abs2", "abs3", "upperthigh", "midthigh", "calf"],
        //         datasets: chart_datasets,
        //     },
        //     options: {
        //         scales: {
        //             yAxes: [{
        //                 ticks: {
        //                     beginAtZero: true
        //                 }
        //             }]
        //         }
        //     }
        // });

        // measurement_chart = new Morris.Area({
        //   element: 'measurements_chart',
        //   data: seperated_chart_data,
        //   xkey: "measurement",
        //   ykeys: measure_labels,
        //   labels: measure_labels,
        //   xLabelMargin: 1,
        //   pointSize: 2,
        //   hideHover: 'auto',
        //   resize: true,
        //   redraw: true,
        // });
        //
        // dynamicChart(measurement_chart, ".encase_measurements_datatable");
      }
    });
    $("select[name='measurements_datatable_length']").formSelect();


  });
</script>
{% endblock scripts %}
